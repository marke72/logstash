input {
  rabbitmq {
    queue => "netflow-queue"
    exchange => "netflow"
    host => "x.x.x.x"
    prefetch_count => 2048
    threads => 16
  }
}

filter {
  if [type] == "netflow" {
    mutate {
      rename => { "[netflow][flow_seq_num]" => "flow_seq_num" }
      rename => { "[netflow][flowset_id]" => "flowset_id" }
      rename => { "[netflow][in_bytes]" => "in_bytes" }
      rename => { "[netflow][in_pkts]" => "in_pkts" }
      rename => { "[netflow][ipv4_dst_addr]" => "dst_ip" }
      rename => { "[netflow][ipv4_src_addr]" => "src_ip" }
      rename => { "[netflow][l4_dst_port]" => "dst_port" }
      rename => { "[netflow][l4_src_port]" => "src_port" }
      rename => { "[netflow][out_bytes]" => "out_bytes" }
      rename => { "[netflow][out_pkts]" => "out_pkts" }
      rename => { "[netflow][protocol]" => "protocol" }
      rename => { "[netflow][version]" => "version" }
    }

    geoip {
      source => "dst_ip"
      target => "dst_geoip"
    }

    # Field for where the event came from
    if [host] == "10.0.47.1" {
      mutate {
        add_field => { "appliance_name" => "MX100_IDF" }
      }
    }
    else if [host] == "10.2.2.129" {
      mutate {
        add_field => { "appliance_name" => "MX64_SL" }
      }
    }
    else if [host] == "192.168.1.1" {
      mutate {
        add_field => { "appliance_name" => "MX100_PIN" }
      }
    }
    else if [host] == "10.128.0.129" {
      mutate {
        add_field => { "appliance_name" => "MX60_COL" }
      }
    }
    else if [host] == "10.1.1.97" {
      mutate {
        add_field => { "appliance_name" => "MX_TX" }
      }
    }
    else if [host] == "10.1.1.33" {
      mutate {
        add_field => { "appliance_name" => "MX_OR" }
      }
    }
    else if [host] == "10.1.0.193" {
      mutate {
        add_field => { "appliance_name" => "MX_VA" }
      }
    }
    else if [host] == "10.81.0.1" {
      mutate {
        add_field => { "appliance_name" => "MX80_RalNC" }
      }
    }
    else if [host] == "192.168.0.1" {
      mutate {
        add_field => { "appliance_name" => "MX80_RalNC" }
      }
    }
    else if [host] == "10.1.2.33" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmMW" }
      }
    }
    else if [host] == "10.1.2.169" {
      mutate {
        add_field => { "appliance_name" => "Z1_CellRamona" }
      }
    }
    else if [host] == "10.1.2.161" {
      mutate {
        add_field => { "appliance_name" => "Z1_CellWheatgrass" }
      }
    }
    else if [host] == "10.1.2.65" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmFH" }
      }
    }
    else if [host] == "10.1.2.49" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmAFS" }
      }
    }
    else if [host] == "10.1.2.129" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmMP" }
      }
    }
    else if [host] == "10.2.1.1" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmRR" }
      }
    }
    else if [host] == "10.2.1.1" {
      mutate {
        add_field => { "appliance_name" => "Z1_FarmRR" }
      }
    }
    else {
      mutate {
        add_field => { "appliance_name" => "updateme" }
      }
    }

    # Add ip_lookup and dshield field
    if [dst_ip] !~ /^10\.(?:[0-9]{1,3}\.){2}[0-9]{1,3}$/ and [dst_ip] !~ /^172\.16\.[0-9]{1,3}\.[0-9]{1,3}$/ and [dst_ip] !~ /^192\.168\.[0-9]{1,3}\.[0-9]{1,3}$/ {
      mutate {
        add_field => { "ip_lookup" => "https://who.is/whois-ip/ip-address/%{dst_ip}" }
        add_field => { "dshield_dst" => "http://dshield.org/ipinfo.html?ip=%{dst_ip}" }
      }
    }

    # Add field protocol_name based on the value in protocol
    if [protocol] == 1 {
      mutate {
        add_field => { "protocol_name" => "icmp" }
      }
    }
    else if [protocol] == 2 {
      mutate {
        add_field => { "protocol_name" => "igmp" }
      }
    }
    else if [protocol] == 6 {
      mutate {
        add_field => { "protocol_name" => "tcp" }
      }
    }
    else if [protocol] == 17 {
      mutate {
        add_field => { "protocol_name" => "udp" }
      }
    }
    else {
      mutate {
        add_field => { "protocol_name" => "updateme" }
      }
    }
  }
}

output {
  if [type] == "netflow" {
    elasticsearch {
      hosts => ["x.x.x.x"]
      index => "netflow-%{+YYYY.MM.dd}"
      manage_template => false
    }
  }
}
